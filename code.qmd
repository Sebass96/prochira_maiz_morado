---
title: "ESTIMULANTES EN LA GERMINACIÓN Y BIOMETRÍA INICIAL DE DOS VARIEDADES DE MAÍZ MORADO (_Zea mays_ L.)"
format:
  html:
    toc: true
    toc-location: left
    toc-expand: 4
    number-sections: true
    self-contained: true
    output-file: "ESM_1"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  echo: true
---

# Setup

Instalar version en desarrollo.

```{r}
#| eval: false

if (!require("remotes"))
  install.packages("remotes")
remotes::install_github("flavjack/inti")
```


```{r}
#| label:  setup

library(emmeans)
library(corrplot)
library(multcomp)
source('https://inkaverse.com/setup.r')

cat("Project: ", getwd())
session_info()
```

# Refrencias

- (PCA) https://www.r-bloggers.com/2017/07/pca-course-using-factominer/
- (PCA) https://www.youtube.com/watch?v=Uhw-1NilmAk&ab_channel=Fran%C3%A7oisHusson
- (HCPC) https://youtu.be/EJqYTDTJJug

# Import data

> https://docs.google.com/spreadsheets/d/1E_l9uV3MT1qlJuVtWK66NgevqPH6fVJCekqNhS_VGm0/edit?gid=1893553741#gid=1893553741

```{r}
url <- "https://docs.google.com/spreadsheets/d/1E_l9uV3MT1qlJuVtWK66NgevqPH6fVJCekqNhS_VGm0/edit?gid=1893553741#gid=1893553741"

gs <- url %>% 
  as_sheets_id()

imbibition <- gs %>% 
  range_read("imbibition") %>% 
  rename_with(~ tolower(.)) %>% 
  mutate(time = tiempo, .after = tiempo) %>% 
  mutate(variedad = case_when(
    variedad %in% c("criollo") ~ "Creole"
    , variedad %in% c("Hibrido") ~ "Hybrid"
  )) %>% 
  mutate(across(1:tiempo, ~ as.factor(.))) 

str(imbibition)

germination <- gs %>% 
  range_read("germination") %>% 
  rename_with(~ tolower(.)) %>% 
  mutate(variedad = case_when(
    variedad %in% c("criollo") ~ "Creole"
    , variedad %in% c("Hibrido") ~ "Hybrid"
  )) %>% 
  mutate(trat = case_when(
    tratamiento %in% "Agua Destilada" ~ "T0"
    , tratamiento %in% "Algas Marinas 1 L/cil" ~ "T1"
    , tratamiento %in% "Algas Marinas 1,5 L/cil" ~ "T2"
    , tratamiento %in% "Azufre 100 gr.200 L-1" ~ "T3"
    , tratamiento %in% "Azufre 150 gr.200 L-1" ~ "T4"
    , tratamiento %in% "Suero de leche 10%" ~ "T5"
    , tratamiento %in% "Suero de leche 30%" ~ "T6"
  ), .before = tratamiento) %>% 
  mutate(across(1:variedad, ~ as.factor(.))) 

str(germination)

plantula <- gs %>% 
  range_read("plantula") %>% 
  rename_with(~ tolower(.)) %>% 
  mutate(variedad = case_when(
    variedad %in% c("criollo") ~ "Creole"
    , variedad %in% c("hibrido") ~ "Hybrid"
  )) %>% 
  mutate(across(1:variedad, ~ as.factor(.)))

str(plantula)
```

# Tratamientos

```{r}
imbibition %>% 
  group_by(trat, tratamiento) %>% 
  summarise(n = n()) %>% 
  select(!n)
```

# Data summary

```{r}
sm <- imbibition %>% 
  group_by(tratamiento, variedad, tiempo) %>% 
  summarise(across(peso, ~ sum(!is.na(.))))

sm

sm <- germination %>% 
  group_by(tratamiento, variedad) %>% 
  summarise(across(pg:ig, ~ sum(!is.na(.))))

sm

sm <- plantula %>% 
  group_by(tratamiento, variedad) %>% 
  summarise(across(where(is.numeric), ~ sum(!is.na(.))))

sm
```

```{r}
#| echo: false

anova_table <- function(model) {
  
  model %>%
    rownames_to_column("Factor") %>% 
    mutate(Sig = case_when(
      `Pr(>F)` <= 0.001  ~ "***"
      , `Pr(>F)` <= 0.01  ~ "**"
      , `Pr(>F)` <= 0.05  ~ "*"
      , `Pr(>F)` > 0.05 ~ "ns"
    )) %>% 
    mutate(across(everything(), as.factor)) %>%
    tibble() %>% 
    tibble::add_row(Factor = "---") %>% 
    tibble::add_row(Factor = "Significance:"
                    , `Sum Sq` = "0.001 ***"
                    , `Mean Sq` = "0.01 **"
                    , `F value` = "0.05 *"
                    )
}
```

# Objetivos

(a) Evaluar los parámetros de germinación de dos variedades de semillas de maiz morado usando bioestimulante orgánico. 

(b) Identificar el mejor tratamiento que influye positivamente en el crecimiento y desarrollo de plantulas en el cultivo de Maíz morado.


## Objetivo Específico 1

> Evaluar los parámetros de germinación de dos variedades de semillas de maiz morado usando bioestimulante orgánico. 

- Imbibiciación, % germinación, velocidad e IG


### Imbibición

```{r}
trait <- "peso"
fb <- imbibition

lmm <- paste({{trait}}, "~ 1 + (1|bloque) + trat*variedad +  (1 + tiempo|tratamiento)") %>% as.formula()

lmd <- paste({{trait}}, "~ bloque + tiempo +  trat*variedad") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers %>% kable()

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ tiempo|variedad|trat) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1a <- mc %>% 
  plot_smr(type = "line"
           , x = "tiempo"
           , y = "emmean"
           , group = "trat"
           , sig = "group"
           , error = "SE"
           , color = T
           , ylab = "Seed weight (g)"
           , xlab = "Time (h)"
           , glab = "Treatment"
           , ylimits = c(0.4, 1, 0.2)
           ) + 
  facet_wrap(. ~ variedad, ncol = 2) +
  theme(legend.position = "top") +
  guides(colour = guide_legend(nrow = 1))

p1a
```

### Porcentaje de Germination

```{r}
trait <- "pg"
fb <- germination

lmm <- paste({{trait}}, "~ 1 + (1|bloque) + trat*variedad") %>% as.formula()

lmd <- paste({{trait}}, "~ bloque + trat*variedad") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers %>% kable()

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ variedad|trat) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1b <- mc %>% 
  plot_smr(type = "bar"
           , x = "trat"
           , y = "emmean"
           , group = "variedad"
           , sig = "group"
           , error = "SE"
           , color = T
           , ylab = "Germination ('%')"
           , xlab = "Treatments"
           , glab = "Variety"
           , ylimits = c(0, 120, 20)
           ) 

p1b
```

### Velocidad de germinación

```{r}
trait <- "vg"
fb <- germination

lmm <- paste({{trait}}, "~ 1 + (1|bloque) + trat*variedad") %>% as.formula()

lmd <- paste({{trait}}, "~ bloque + trat*variedad") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers %>% kable()

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ variedad|trat) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1c <- mc %>% 
  plot_smr(type = "bar"
           , x = "trat"
           , y = "emmean"
           , group = "variedad"
           , sig = "group"
           , error = "SE"
           , color = T
           , ylab = "Germination speed (days)"
           , xlab = "Treatments"
           , glab = "Variety"
           , ylimits = c(0, 6, 1)
           ) 

p1c
```

### Indice de germinación

```{r}
trait <- "ig"
fb <- germination

lmm <- paste({{trait}}, "~ 1 + (1|bloque) + trat*variedad") %>% as.formula()

lmd <- paste({{trait}}, "~ bloque + trat*variedad") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

rmout$diagplot

rmout$outliers %>% kable()

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model)

mc <- emmeans(model, ~ variedad|trat) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group")

mc %>% kable()

p1d <- mc %>% 
  plot_smr(type = "bar"
           , x = "trat"
           , y = "emmean"
           , group = "variedad"
           , sig = "group"
           , error = "SE"
           , color = T
           , ylab = "Germination Index"
           , xlab = "Treatments"
           , glab = "Variety"
           , ylimits = c(0, 5, 1)
           ) 

p1d
```

## Figura 1

```{r}
legend <- cowplot::get_plot_component(p1b, 'guide-box-top', return_all = TRUE)

p1i <- list(p1b + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1c + labs(x = NULL) + theme(legend.position="none"
                                        , axis.title.x=element_blank()
                                        , axis.text.x=element_blank()
                                        , axis.ticks.x=element_blank())
           , p1d + labs(x = NULL) + theme(legend.position="none")
           ) %>% 
  plot_grid(plotlist = ., ncol = 1
            , labels = c("b", "c", "d")
            ) 

p1il <- list(legend, p1i) %>% 
  plot_grid(plotlist = ., ncol = 1, align = 'v', rel_heights = c(0.05, 1))


plot <- list(p1a, p1il) %>% 
  plot_grid(plotlist = .
            , ncol = 1
            , labels = c("a")
            , rel_heights = c(0.6, 1)
            )  
  
plot %>% 
  ggsave2(plot = ., "files/Fig-1.jpg"
         , units = "cm"
         , width = 24
         , height = 29
         )

plot %>% 
  ggsave2(plot = ., "files/Fig-1.eps"
         , units = "cm"
         , width = 24
         , height = 29
         )

knitr::include_graphics("files/Fig-1.jpg")
```

## Objetivo Específico 2

> Identificar el mejor tratamiento que influye positivamente en el crecimiento y desarrollo de plantulas en el cultivo de Maíz morado.

```{r}
#| results: asis

fb <- plantula %>% 
  select(!contains("fres"))

rsl <- 5:length(fb) %>% map(\(x) {
  
trait <- names(fb)[x]

cat("\n### ", trait)

lmm <- paste({{trait}}, "~ 1 + (1|bloque) + trat*variedad") %>% as.formula()

lmd <- paste({{trait}}, "~ bloque + trat*variedad") %>% as.formula()

rmout <- fb %>% 
  remove_outliers(formula = lmm
                  , drop_na = T, plot_diag = T)

cat("\n#### ",  "Diagnostico")

rmout$diagplot %>% print()

cat("\n#### ", "Outliers")

rmout$outliers  %>% kable() %>% print()

cat("\n#### ", "ANOVA")

model <- rmout$data$clean %>% 
  aov(formula = lmd, .)

anova(model) %>% anova_table %>% kable() %>% print()

cat("\n#### ", "Mean comparison")

mc <- emmeans(model, ~ variedad|trat) %>%
  cld(Letters = letters, reversed = T) %>%
  mutate(across(.group, trimws)) %>% 
  rename(group = ".group") %>% 
  rename({{trait}} := "emmean")

mc %>% kable() %>% print()

plot <- mc %>% 
  plot_smr(x = "trat"
           , y = trait
           , group = "variedad"
           , sig = "group"
           , error = "SE"
           , color = T
           , xlab = "Treatments"
           , glab = "Variety"
           )

plot

list(mc = mc, plot = plot)
  
})
```

### Figure 2

```{r}

legend <- cowplot::get_plot_component(rsl[[1]]$plot, 'guide-box-top', return_all = TRUE)

fig <- list(
  rsl[[1]]$plot + labs(x = NULL, y = "Root length (cm)") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 20), n.breaks = 5) +
    theme(legend.position="none"
          , axis.title.x=element_blank()
          , axis.text.x=element_blank()
          , axis.ticks.x=element_blank())
  
  , rsl[[2]]$plot + labs(x = NULL, y = "Root thickness (mm)") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 2), n.breaks = 5) +
    theme(legend.position="none"
          , axis.title.x=element_blank()
          , axis.text.x=element_blank()
          , axis.ticks.x=element_blank())
  
  , rsl[[3]]$plot  + labs(x = NULL, y = "Root number") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 20), n.breaks = 5) +
    theme(legend.position="none"
          , axis.title.x=element_blank()
          , axis.text.x=element_blank()
          , axis.ticks.x=element_blank())
  
  , rsl[[4]]$plot + labs(y = "Root dry weight (g)") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, 2), n.breaks = 5) +
    theme(legend.position="none") 
  ) %>% 
  plot_grid(plotlist = .
            , ncol = 1
            , labels = "auto"
              ) 

plot <- list(legend, fig) %>% 
   plot_grid(plotlist = .
            , ncol = 1
            , rel_heights = c(0.05, 1)
              ) 

plot %>% 
  ggsave2(plot = .
          , "files/Fig-2.jpg"
          , units = "cm"
          , width = 12
          , height = 24
         )

plot %>% 
  ggsave2(plot = .
          , "files/Fig-2.eps"
          , units = "cm"
          , width = 12
          , height = 24
         )

include_graphics("files/Fig-2.jpg")
```

### Table

```{r}
tab <- 5:length(rsl) %>% map(\(x) { 
  
  trait <- names(rsl[[x]]$mc)[[3]]
  
  rsl[[x]]$mc %>% 
    mutate(across(where(is.numeric), ~ round(., 2))) %>% 
    unite({{trait}}, c({{trait}}, group), sep = " ") %>% 
    select(1:3)
  
  }) %>% 
  Reduce(function(...) merge(..., all = TRUE), .) %>% 
  rename(Variety = "variedad" 
         , Treatment = trat
         , "Plant height (cm)" = "alt_planta"
         , "Stem thickness (mm)" = "gsr_tallo"
         , "Leaves number" = "nhp_hoja"
         , "Leaf length (cm)" = "larg_hoja" 
         , "Leaf thickness (mm)" = "grs_hoja"
         , "Leaf width (mm)" = "anch_hoja"
         , "Shoot Dry weight (g)" = "peso_seco_brote"
         ) %>% 
  arrange(Treatment)

tab %>% kable()

tab %>% sheet_write(data = ., gs, "table")
```

### PCA

```{r}
blues <- 1:length(rsl) %>% map(\(x) { 
  
  rsl[[x]]$mc %>% 
    select(1:3)
  
  }) %>% 
  Reduce(function(...) merge(..., all = TRUE), .) %>% 
    rename(Variety = "variedad" 
         , Treatment = trat
         , "Plant height (cm)" = "alt_planta"
         , "Stem thickness (mm)" = "gsr_tallo"
         , "Leaves number" = "nhp_hoja"
         , "Leaf length (cm)" = "larg_hoja" 
         , "Leaf thickness (mm)" = "grs_hoja"
         , "Leaf width (mm)" = "anch_hoja"
         , "Shoot Dry weight (g)" = "peso_seco_brote"
         #>
         , "Root length (cm)" = "raiz_lgtd"
         , "Root thickness (mm)" = "gsr_raiz"
         , "Root number" = "num_raiz"
         , "Root Dry weight (g)" = peso_seco_raiz
         )
  
blues %>% str()
```

```{r}
pca <- blues %>% 
  select(!c("Leaves number")) %>% 
  unite("treat", c(Treatment, Variety), remove = F, sep = "-") %>% 
  column_to_rownames("treat") %>% 
  PCA(scale.unit = T, quali.sup = c(1:2), graph = F)

summary(pca, nbelements = Inf, nb.dec = 2)
pcainfo <- factoextra::get_pca_var(pca)
pcainfo$cor
pcainfo$contrib
```

### Figure 3

```{r}
var <- pca %>% 
  plot.PCA(choix = "var"
           , cex = 0.7 
           )

ind <- pca %>% 
  plot.PCA(choix = "ind", habillage = 2
           , label = c("ind")
           , invisible = "quali"
           ) +
  labs(colour = "Treatments") +
  theme(legend.position = "bottom"
        , legend.direction = "horizontal") +
  guides(colour = guide_legend(nrow = 1))
  

fig <- list(var, ind) %>% 
    plot_grid(plotlist = .
              , ncol = 2
              , labels = "auto"
              , rel_widths = c(1.5, 2)
              ) 

fig %>% 
  ggsave2(plot = .
          , "files/Fig-3.jpg"
          , units = "cm"
          , width = 30
          , height = 12
         )

fig %>% 
  ggsave2(plot = .
          , "files/Fig-3.eps"
          , units = "cm"
          , width = 30
          , height = 12
         )

include_graphics("files/Fig-3.jpg")
```

